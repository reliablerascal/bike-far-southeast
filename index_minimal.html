<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>[Minimum Viable Code] Bike Access in Chicago's Far Southeast Side</title>
    
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/mapbox/assembly/publisher-staging/src/svgs/mapbox.svg">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/intersection-observer@0.12.0/intersection-observer.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    
    <style>
        body {
            margin:0;
            padding:0;
            font-family: sans-serif;
        }
        #map {
            position: sticky;
            top: 0;
            height:100vh;  
            width:100%;
        }
        .lefty {
            width: 33vw;
            margin-left: 5vw;
        }
        .dark {
            color: #F4F7D9;
            background-color: #0D506D;
        }
        .step {
            padding-bottom: 50vh;
            opacity: 0.25;
        }
        .step.active {
            opacity: 0.99;
        }
        .step div {
            padding:  25px 50px;
            line-height: 25px;
            font-size: 13px;
        }

        /* Fix issue on mobile browser where scroll breaks  */
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan,
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan .mapboxgl-canvas {
            touch-action: unset;
        }
        </style>
</head>
<body>

<main id="project-wrapper">

<div id="intro">
    <h1>[Minimum Viable Code] Bike Access in Chicago's Far Southeast Side</h1>
    <h3><em>Chicago's Southeast side possesses a wealth of waterfront and park space, but bikers can't yet safely access it.</em></h3>
    <br>
</div>

<div id="map"></div>
<div id="story"></div>

</main>

<footer>
<div id="outro">
    <p> hobgoblaroblin boblin to the scoblin
        <p>hobgoblaroblin boblin to the scoblin
        <p>hobgoblaroblin boblin to the androscoblin
        <p>hobgoblaroblin boblin to the androscoblin
</div>
</footer>

<script>
var config = {
    style: 'mapbox://styles/robcat26/cllfi4uo901m701qleb6n02ik',
    accessToken: 'pk.eyJ1Ijoicm9iY2F0MjYiLCJhIjoiY2xtNWF5bGYzMDNkbTNubzhnZTJxZ2x3ZyJ9.s980uralAwWmIhegxpNs2A',
    theme: 'dark',
    chapters: [
        {
            id: 'zoom-scene',
            description: 'Hegewisch and East Side, Chicago\'s southeasternmost neighborhoods, possess an abundance of park space, including Eggers Grove, Wolf Lake, Calumet Park, and Hegewisch Marsh Park. The I-90 expressway and major streets including 106th Street and Ewing Avenue facilitate automobile access for far away visitors. But these resources remain underutilized, in part because access remains treacherous for local residents-- especially cyclists.',
            location: {
                center: [-87.54426, 41.68283],
                zoom: 12.75,
                pitch: 0.00,
                bearing: 0.00
            },
            onChapterEnter: [
            ],
            onChapterExit: []
        },
        {
            id: 'hegewisch-marsh-park',
            description: 'Amongst the region\'s highlights, Hegewisch Marsh Park recently received a $500,000 grant from the National Coastal Resilience Fund. The Hegewisch Neighborhood Plan released this month considers this park an "underutilized" resource, and recognizes the potential value of improved bike access for local businesses.',
             location: {
                center: [-87.56236604152772, 41.6556252316896],
                zoom: 12.75,
                pitch: 0.00,
                bearing: 0.00
            },
            onChapterEnter: [
                {layer: 'park-hegewisch', opacity:1}
            ],
            onChapterExit: [
                {layer: 'park-hegewisch', opacity:0}
            ]
        },
        {
            id: 'existing-bike-lanes',
            description: 'The area has some bike lanes, mostly shared and buffered lanes along city streets. But not all of these feel safe. For example, the Hegewisch Neighborhood Plan noted that resident felt unsafe on 134th Street near Avenue O due to "excessive speeding by cars" and large trucks which are supposed to be legally prohibited from the road.',
            location: {
                center: [-87.55685590723697,
                    41.659210130018266],
                zoom: 12,
                pitch: 0.00,
                bearing: 0.00
            },
            onChapterEnter: [ 
                {layer: 'bike-lanes', opacity:1}
            ],
            onChapterExit: [
                {layer: 'bike-lanes', opacity:0}
            ]
        }
    ]
};
</script>

<script>
var initLoad = true;
var layerTypes = {
    'fill': ['fill-opacity'],
    'line': ['line-opacity'],
    'circle': ['circle-opacity', 'circle-stroke-opacity'],
    'symbol': ['icon-opacity', 'text-opacity'],
    'raster': ['raster-opacity'],
    'fill-extrusion': ['fill-extrusion-opacity'],
    'heatmap': ['heatmap-opacity']
}

function getLayerPaintType(layer) {
    var layerType = map.getLayer(layer).type;
    return layerTypes[layerType];
}

function setLayerOpacity(layer) {
    var paintProps = getLayerPaintType(layer.layer);
    paintProps.forEach(function(prop) {
        var options = {};
        map.setPaintProperty(layer.layer, prop, layer.opacity, options);
    });
}

var story = document.getElementById('story');
var features = document.createElement('div');
features.setAttribute('id', 'features');
features.style.border = '10px solid purple';

//for each chapter...
config.chapters.forEach((record, idx) => {
    var container = document.createElement('div');

    container.style.border = '1px solid red';
    
    var chapter = document.createElement('div');

    var story = document.createElement('p');
    story.innerHTML = record.description;
    chapter.appendChild(story);
    
    container.setAttribute('id', record.id);
    container.classList.add('step');
    if (idx === 0) {
        container.classList.add('active');
    }

    chapter.classList.add(config.theme);
    container.appendChild(chapter);
    features.appendChild(container);
});

story.appendChild(features);
mapboxgl.accessToken = config.accessToken;

//create starting point for the map
var map = new mapboxgl.Map({
    container: 'map',
    style: config.style,
    center: config.chapters[0].location.center,
    zoom: config.chapters[0].location.zoom,
    bearing: config.chapters[0].location.bearing,
    pitch: config.chapters[0].location.pitch,
    interactive: false,
    projection: config.projection
});

// instantiate the scrollama
var scroller = scrollama();

map.on("load", function() {
    
    // setup the instance, pass callback functions
    scroller
    .setup({
        step: '.step',
        offset: 0.5, //1 = begins when container hits top, 0.5 begins when it's 1/2 screen up
        progress: true,
        debug: true
    })
    .onStepEnter(async response => {
        var current_chapter = config.chapters.findIndex(chap => chap.id === response.element.id);
        var chapter = config.chapters[current_chapter];

        response.element.classList.add('active');
        map['flyTo'](chapter.location);
        chapter.onChapterEnter.forEach(setLayerOpacity);
    })
    
    .onStepExit(response => {
        var chapter = config.chapters.find(chap => chap.id === response.element.id);

        response.element.classList.remove('active');
        chapter.onChapterExit.forEach(setLayerOpacity);
    });
});

// setup resize event
window.addEventListener('resize', scroller.resize);
</script>

<div id="outro2">
    <p>morg bagorg kaforg blorg
        <br>morg bagorg kaforg blorg
        <br>morg bagorg kaforg blorg
        <br>morg bagorg kaforg blorg
        <br>morg bagorg kaforg blorg
        <br>morg bagorg kaforg blorg
        <br>morg bagorg kaforg blorg
        <br>morg bagorg kaforg blorg
        <br>morg bagorg kaforg blorg
        <br>morg bagorg kaforg blorg
        <br>morg bagorg kaforg blorg
    </div>
</body>
</html>